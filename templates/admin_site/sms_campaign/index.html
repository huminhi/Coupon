{% extends "grid_v2.html" %}
{% load i18n %}
{% block extrastyle %}{{ block.super }}		
    <link rel="stylesheet" type="text/css" href="/media/uploader/fileuploader.css" />
{% endblock %}
{% block title %}Admin - SMS Campaign - Admin Portal{% endblock %}
{% block grid_content %}
	<div id="content-main">
		<h1>Custom SMS Campaign</h1>
		<table>
			<tr>
				<td style="vertical-align: middle;">Priority:</td>
				<td style="vertical-align: middle;">
					<select id="id_cbo_custom_priority">
						<option value="0">0 - Lowest</option>
						<option value="1">1</option>
						<option value="2">2</option>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
						<option value="6">6</option>
						<option value="7">7</option>
						<option value="8">8</option>
						<option value="9">9 - Highest</option>
					</select>
				</td>
				<td style="vertical-align: middle;">Send Time</td>
				<td style="vertical-align: middle;">
					<input type="text" value="" name="from" id="id_txt_custom_date" style="width:80px"/><input type="text" value="{{ time_now }}" name="from_time" id="id_txt_custom_time"  style="width:40px"/>
				</td>
				<td style="vertical-align: middle;"><input type="checkbox" id="id_chk_default_custom_send_date"/></td>
				<td style="vertical-align: middle;">Immediately</td>
			</tr>
		</table>
		<table>
			<tr>
				<td style="vertical-align: middle;">Promotion Id</td>
				<td style="vertical-align: middle; width: 100px;"><input type="text" id="id_txt_promo_id"/></td>
				<td style="vertical-align: middle;">From Phone</td>
				<td style="vertical-align: middle;"><input type="text" id="id_txt_from_phone"/></td>
				<td style="vertical-align: middle;"><input type="checkbox" id="id_chk_default_from_phone"/></td>
				<td style="vertical-align: middle;">Use default</td>
			</tr>
		</table>
		<table>
            <tr style="display: none;">
                <td style="vertical-align: middle;"><input type="checkbox" id="id_chk_topup"/></td>
                <td style="vertical-align: middle;">Topup</td>
            </tr>
            <tr>
                <table id='id_table_topup' style="display: none;">
		            <tr>
		                <td style="vertical-align: middle;">Country:</td>
		                <td style="vertical-align: middle;">
		                    <select id="id_cbo_country" style="width: 200px">
		                        <option value="">[Select]</option>
		                        {% for item in countries %}
		                        <option value="{{ item.0 }}">{{ item.1 }}</option>
		                        {% endfor %}
		                    </select>
		                </td>
		                <td style="vertical-align: middle;">Operator:</td>
		                <td style="vertical-align: middle;">
		                    <select id="id_cbo_operator" style="width: 200px">
		                        <option value="">[Select]</option>
		                        {% for item in carriers %}
		                        <option value="{{ item.0 }}">{{ item.1 }}</option>
		                        {% endfor %}
		                    </select>
		                </td>
		                <td style="vertical-align: middle;">Language:</td>
		                <td style="vertical-align: middle;">
		                    <select id="id_cbo_language" style="width: 200px">
		                        <option value="en">English</option>
		                        <option value="sp">Spanish</option>
		                    </select>
		                </td>
		                <td style="vertical-align: middle;">Company:</td>
		                <td style="vertical-align: middle;">
		                    <select id="id_cbo_company" style="width: 200px">
		                        <option value="">None</option>
		                        {% for item in companies %}
		                        <option value="{{ item.0 }}">{{ item.1 }}</option>
		                        {% endfor %}
		                    </select>
		                </td>
		            </tr>
		        </table>
            </tr>
        </table>
		<table>
			<tr>
				<td colspan="4">SMS Template:</td>
			</tr>
			<tr>
				<td colspan="4">
					<textarea rows="5" cols="70" id="id_txt_sms"></textarea>
					<input id="id_btn_sendsms_custom" type="button" value=" Send SMS "/>
					<input id="id_btn_export_csv" type="button" value=" Export CSV " style="display:None"/>
				</td>
			</tr>
		</table>
		
		<div id="toolbarpannel">
			<div id="file-uploader">       
			    <noscript>          
			        <p>Please enable JavaScript to use file uploader.</p>
			        <!-- or put a simple form for upload here -->
			    </noscript>         
			</div>
		</div>
		<div style="clear: left;"></div>
		<br/>
		<div id="csrf_token">{% csrf_token %}</div>
		<input type="hidden" value="-1" name="selected_file" id="selected_file"/>
		<input type="hidden" value="" id="id_hid_rawdata"/>
		<input type="hidden" value="{{ now }}" id="id_date_now" name="now"/>
		
		<table class="ui-jqgrid-btable" width="100%" cellspacing="0" cellpadding="0" id="id_table_items">
		</table>
	</div>
	<div id="div_error" style="display:none" title="Warning">
		Some data is invalid(duplicate promoid). Please download following file for more information<br/>
		<a id="id_link_error" style="color: blue; " href="#">Download</a>
	</div>
	<script src="/media/uploader/fileuploader.js" type="text/javascript"> </script>
	<script src="/media/js/jquery-ui-1.8.16.custom.min.js" type="text/javascript"> </script>
	<script src="/media/js/jquery.maskedinput-1.2.2.min.js" type="text/javascript"> </script>
	<script type="text/javascript">
		$(document).ready(function(){	
			initialize();
			
			var csrf_token = $('#csrf_token >div >input').attr("value");
			var uploader = new qq.FileUploader({
			    element: document.getElementById('file-uploader'),
			    action: '/adminmng/smscampaign/json/uploadfile/',
			    params: {
			        csrfmiddlewaretoken : csrf_token
			    },
			    onSubmit: function(id, fileName){
			    	//uploader.setParams({
					//   'bank_account': jQuery("#bank_account").val()
					//});
			    },
			    onComplete: function(id, fileName, data){
			    	$("#id_hid_rawdata").val(data.RawData);
			    	tableRender(data.Header, data.Data);
			    }				        				    								    
			});
			
			$('#id_chk_topup').change(function() {
			     if($('#id_chk_topup').is(':checked')){
			         $('#id_table_topup').show();
			         $('#id_btn_export_csv').show();
			     }
			         
			     else{
			         $('#id_table_topup').hide();
			         $('#id_btn_export_csv').hide();
			     }
			});    
		});	

		function tableRender(header, data) {
			$('#id_table_items').find('.data-header-item').remove();
			$('#id_table_items').find('.data-detail-item').remove();

			var html = '';
			html += '<tr class="ui-widget-content jqgrow ui-row-ltr data-header-item">';
			$(header).each(function (i,item){
				html += '<th>'+item+'</th>';
			});
			$('#id_table_items').append($(html));
			
			$(data).each(function (i,item){			
				var html = '';
				html += '<tr class="ui-widget-content jqgrow ui-row-ltr data-detail-item">';
				$(item).each(function (i,subitem){	
					html += '<td>'+subitem+'</td>';
				});
				$('#id_table_items').append($(html));
			});
		}
		
		function initialize() {
			//$("#id_txt_from_phone").mask("(999) 999-9999");
			$("#id_chk_default_from_phone").click(function() {
				if ($("#id_chk_default_from_phone").attr("checked")) {
					$("#id_txt_from_phone").attr("disabled", "disabled");
				} else {
					$("#id_txt_from_phone").attr("disabled", "");
				}
			});
			$("#id_chk_default_from_phone").click();
			$("#id_txt_from_phone").attr("disabled", "disabled");
			
			jQuery("#id_txt_from").datepicker({
		        dateFormat: 'MM dd, yy',
		        clickInput: true,
		        createButton: false,
		    });

		    jQuery("#id_txt_to").datepicker({
		        dateFormat: 'MM dd, yy',
		        clickInput: true,
		        createButton: false,
		    });
		    
		    jQuery("#id_txt_topup_date").datepicker({
		        dateFormat: 'mm/dd/yy',
		        clickInput: true,
		        createButton: false,
		        minDate: new Date()
		    }).datepicker('setDate', new Date());
		    
		    jQuery("#id_txt_custom_date").datepicker({
		        dateFormat: 'mm/dd/yy',
		        clickInput: true,
		        createButton: false,
		        minDate: new Date($('#id_date_now').val())
		    }).datepicker('setDate', new Date($('#id_date_now').val()));
		    
		    $("#id_chk_default_topup_send_date").click(function() {
		    	if ($("#id_chk_default_topup_send_date").attr("checked")) {
		    		$("#id_txt_topup_date").attr("disabled", "disabled");
					$("#id_txt_topup_time").attr("disabled", "disabled");	
		    	} else {
		    		$("#id_txt_topup_date").attr("disabled", "");
					$("#id_txt_topup_time").attr("disabled", "");
		    	}
		    });
		    
		    $("#id_chk_default_custom_send_date").click(function() {
				if ($("#id_chk_default_custom_send_date").attr("checked")) {
		    		$("#id_txt_custom_date").attr("disabled", "disabled");
					$("#id_txt_custom_time").attr("disabled", "disabled");	
		    	} else {
		    		$("#id_txt_custom_date").attr("disabled", "");
					$("#id_txt_custom_time").attr("disabled", "");
		    	}
		    });
		    
		    $("#id_chk_default_topup_send_date").click();
		    $("#id_chk_default_custom_send_date").click();
		    
		    $("#id_txt_topup_date").attr("disabled", "disabled");
			$("#id_txt_topup_time").attr("disabled", "disabled");	
			$("#id_txt_custom_date").attr("disabled", "disabled");
			$("#id_txt_custom_time").attr("disabled", "disabled");	
		}

		$("#id_cbo_country").change(function() {
			DoJSONGet("/adminmng/smscampaign/json/getcarrier/?iddcode=" + $("#id_cbo_country").val(), "", function(data) {
				if(data != "") {
                	$("#id_cbo_operator").html("");
                    $("<option value=\"\">[Select]</option>").appendTo("#id_cbo_operator");
                    $.each(data, function(i, item) {
                    	$("<option value=\"" + item[0] + "\">" + item[1] + "</option>").appendTo("#id_cbo_operator");
                    });
                    $("#id_cbo_operator option:first-child").attr("selected", "selected");
                } else {
	                $("#id_cbo_operator").html("");
                    $("<option value=\"\">[Select]</option>").appendTo("#id_cbo_operator");
                }
			});
		});
		
		$('#id_btn_export_csv').click(function() {
		    if(($("#id_cbo_country").val() == "" || $("#id_cbo_operator").val() == "")) {
                alert("Please choose a country and an operator");
                return ;
            }

            var from_phone = $("#id_txt_from_phone").val().replace(/[^\d]*/gi,"")
            var default_from_phone = $("#id_chk_default_from_phone").attr("checked")
            var operator = $("#id_cbo_operator").val().replace(/ /g, "_");
            var country = $("#id_cbo_country").val()
            var company = $("#id_cbo_company").val()
            operator = operator.replace(/-/g, "iii");
            operator = operator.replace(/&/g, "jjj");
            var url = "/adminmng/smscampaign/export_csv_sms_template/?country=" + country + "&operator=" + operator + "&from_phone=" + from_phone + "&default_from_phone=" + default_from_phone + "&company=" + company
            window.location.href = url;
		});
		
		function btn_sendsms_template_click()
		{
			if(($("#id_cbo_country").val() == "" || $("#id_cbo_operator").val() == "")) {
				alert("Please choose a country and an operator");
				return ;
			}
			//else if (($("#id_txt_promoname").val() == "") ||
			//		($("#id_txt_from").val() == "") ||
			//		($("#id_txt_to").val() == "")) {
			//	alert("Please fill all information for the promotion");
			//	return ;
			//}

			var operator = $("#id_cbo_operator").val().replace(/ /g, "_");
			operator = operator.replace(/-/g, "iii");
			operator = operator.replace(/&/g, "jjj");
			
			var params = {
					"promo_id": $("#id_txt_promo_id").val(),
					"country": $("#id_cbo_country").val(),
					"company": $("#id_cbo_company").val(),
					"operator": operator,
					"priority": $("#id_cbo_custom_priority").val(),
					"send_date": fromUIDate($("#id_txt_custom_date").datepicker('getDate')),
					"send_time": $("#id_txt_custom_time").val(),
					"send_now": $("#id_chk_default_custom_send_date").attr("checked"),
					"template": $("#id_txt_sms").val(),
					"from_phone": $("#id_txt_from_phone").val().replace(/[^\d]*/gi,""),
					"default_from_phone": $("#id_chk_default_from_phone").attr("checked"),
			};

			$("#id_btn_sendsms_template").attr("disabled", "disabled");
			DoJSONPost("/adminmng/smscampaign/json/presendsms/", params, function(data) {
				if (data.ErrorCode == 0) {
					if (confirm("Do you really want to send SMS to " + data.CustomerCount + " customers?")) {
						DoJSONPost("/adminmng/smscampaign/json/sendsms_template/", params, function(data2) {
							if (data2.ErrorCode == 0) {
								showAlertMsg(data2.Message);
							} else {
								showAlertMsg(data2.Message, true);
							}		
						});
					}
				} else {
					showAlertMsg(data.Message, true)
				}
				$("#id_btn_sendsms_template").attr("disabled", "");
			});
			
		}
		
		function btn_sendsms_custom_click()
		{
			if($("#id_txt_sms").val() == "") {
				alert("SMS template content is empty.");
				return ;
			}
			else if ($("#id_hid_rawdata").val() == "") {
				alert("There is no data to send SMS");
				return ;
			}
			else if (!$("#id_chk_default_from_phone").attr("checked")) {
				if ($("#id_txt_from_phone").val() == "") {
					alert("Please fill From Phone");
					return;
				}
			}
			
			var params = {
				"promo_id": $("#id_txt_promo_id").val(),
				"template": $("#id_txt_sms").val(),
				"data": $("#id_hid_rawdata").val(),
				"from_phone": $("#id_txt_from_phone").val().replace(/[^\d]*/gi,""),
				"default_from_phone": $("#id_chk_default_from_phone").attr("checked"),
				"priority": $("#id_cbo_custom_priority").val(),
				"send_date": fromUIDate($("#id_txt_custom_date").datepicker('getDate')),
				"send_time": $("#id_txt_custom_time").val(),
				"send_now": $("#id_chk_default_custom_send_date").attr("checked"),
			};

			$("#id_btn_sendsms_custom").attr("disabled", "disabled");
			DoJSONPost("/adminmng/smscampaign/json/presendcustomsms/", params, function(data) {
				
				if (data.ErrorCode == 0) {
					if (confirm("Do you really want to send SMS to " + data.CustomerCount + " customers?\n"+ data.WarningMessage + "SMS Sample: " + data.Sample)) {
						DoJSONPost("/adminmng/smscampaign/json/sendcustomsms/", params, function(data2) {
							if (data2.ErrorCode == 0) {
								showAlertMsg(data2.Message);
								
							} else {
								showAlertMsg(data2.Message, true);
								return;
							}
							
							if (data2.HasSamePhone){
								//show popup + link download
								var url = "/media/upload_files/sms_campaign_error/" + data2.Url
								$('#id_link_error').attr('href', url)
								showErrorDialog();
							}else{
								window.location.href=window.location
								//window.location.reload();
							}
							
						});
					}
				} else {
					showAlertMsg(data.Message, true);
				}
				$("#id_btn_sendsms_custom").attr("disabled", "");
			});
			
		}
		
		$("#id_btn_sendsms_custom").click(function(){
			if (validateDate()){
			     if($('#id_chk_topup').is(':checked'))
			    	 btn_sendsms_template_click();
			     else
			    	 btn_sendsms_custom_click();
			}
		});
		
		$("#id_txt_promo_id").keydown(function (e) {
		    // Allow: backspace, delete, tab, escape, enter and .
		    if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
		         // Allow: Ctrl+A
		        (e.keyCode == 65 && e.ctrlKey === true) || 
		         // Allow: home, end, left, right
		        (e.keyCode >= 35 && e.keyCode <= 39)) {
		             // let it happen, don't do anything
		             return;
		    }
		    // Ensure that it is a number and stop the keypress
		    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
		        e.preventDefault();
		    }
		});
		
		function ErrorDialog(config) {
			this.dialogId = config['id'];
			this.fileId = config['file_id'];
			this.Initialize();	
		}

		$.extend(ErrorDialog.prototype,BaseDialog.prototype);

		ErrorDialog.prototype.Initialize = function(){
			
		}

		ErrorDialog.prototype.Show = function() {
			var t = this;
			var fileId = this.fileId;
			$( this.dialogId ).dialog({
				modal: true,
				width: 400,
				height: 170,
				buttons: {
		            Close: function() {
		                $( this ).dialog( "close" );
		            }
		        },
		        close: function() {
		        	window.location.reload();
		        	initialize();
		        },
		        resizable: true
			});
		}

		function showErrorDialog(file_id){
			dlgError = new ErrorDialog({
				'id': '#div_error',
				'file_id' : file_id	
			});
			
			dlgError.Show({})
		}
	</script>
{% endblock %}
